<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="built-on" content="2025-10-26T04:06:33.584715471"><title>Database: Migrations | Elegant</title><script type="application/json" id="virtual-toc-data">[{"id":"introduction","level":0,"title":"Introduction","anchor":"#introduction"},{"id":"generating-migrations","level":0,"title":"Generating Migrations","anchor":"#generating-migrations"},{"id":"migration-structure","level":0,"title":"Migration Structure","anchor":"#migration-structure"},{"id":"creating-tables","level":0,"title":"Creating Tables","anchor":"#creating-tables"},{"id":"column-types","level":0,"title":"Column Types","anchor":"#column-types"},{"id":"column-modifiers","level":0,"title":"Column Modifiers","anchor":"#column-modifiers"},{"id":"foreign-key-constraints","level":0,"title":"Foreign Key Constraints","anchor":"#foreign-key-constraints"},{"id":"modifying-tables","level":0,"title":"Modifying Tables","anchor":"#modifying-tables"},{"id":"renaming-and-dropping-tables","level":0,"title":"Renaming and Dropping Tables","anchor":"#renaming-and-dropping-tables"},{"id":"creating-functions","level":0,"title":"Creating Functions","anchor":"#creating-functions"},{"id":"running-migrations","level":0,"title":"Running Migrations","anchor":"#running-migrations"},{"id":"rolling-back-migrations","level":0,"title":"Rolling Back Migrations","anchor":"#rolling-back-migrations"},{"id":"database-specific-considerations","level":0,"title":"Database-Specific Considerations","anchor":"#database-specific-considerations"},{"id":"troubleshooting","level":0,"title":"Troubleshooting","anchor":"#troubleshooting"},{"id":"next-steps","level":0,"title":"Next Steps","anchor":"#next-steps"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><link href="static/custom.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Database: Migrations | Elegant"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Elegant Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/migrations.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Database: Migrations | Elegant"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/migrations.html#webpage",
    "url": "writerside-documentation/migrations.html",
    "name": "Database: Migrations | Elegant",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Elegant Help"
}</script><!-- End Schema.org --></head><body data-id="Migrations" data-main-title="Database: Migrations" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Database"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Elegant  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Migrations" id="Migrations.md">Database: Migrations</h1><section class="chapter"><h2 id="introduction" data-toc="introduction">Introduction</h2><p id="z8pjcxg_19">Database migrations are version control for your database schema. They allow your team to define, share, and track changes to the database structure over time. With migrations, you can:</p><ul class="list _bullet" id="z8pjcxg_20"><li class="list__item" id="z8pjcxg_22"><p id="z8pjcxg_27"><span class="control" id="z8pjcxg_28">Track Changes</span> - Every schema modification is recorded and versioned</p></li><li class="list__item" id="z8pjcxg_23"><p id="z8pjcxg_29"><span class="control" id="z8pjcxg_30">Collaborate Safely</span> - Team members can pull schema changes alongside code changes</p></li><li class="list__item" id="z8pjcxg_24"><p id="z8pjcxg_31"><span class="control" id="z8pjcxg_32">Rollback Errors</span> - Undo problematic migrations when issues arise</p></li><li class="list__item" id="z8pjcxg_25"><p id="z8pjcxg_33"><span class="control" id="z8pjcxg_34">Environment Parity</span> - Ensure consistent database structure across development, staging, and production</p></li><li class="list__item" id="z8pjcxg_26"><p id="z8pjcxg_35"><span class="control" id="z8pjcxg_36">Automate Deployment</span> - Run migrations as part of your deployment pipeline</p></li></ul><p id="z8pjcxg_21">Elegant's migration system provides a database-agnostic API that works consistently across MySQL, MariaDB, PostgreSQL, and SQLite.</p></section><section class="chapter"><h2 id="generating-migrations" data-toc="generating-migrations">Generating Migrations</h2><section class="chapter"><h3 id="generate-migration-files" data-toc="generate-migration-files">Generate Migration Files</h3><p id="z8pjcxg_40">Use the <code class="code" id="z8pjcxg_45">make:migration</code> command to create a new migration file:</p><div class="code-block" data-lang="bash">
elegant make:migration CreateUsersTable
</div><p id="z8pjcxg_42">This generates a timestamped migration file in your <code class="code" id="z8pjcxg_46">resources/database/migrations</code> directory:</p><div class="code-block" data-lang="bash">
resources/database/migrations/20250101120000_CreateUsersTable.ts
</div><p id="z8pjcxg_44">The timestamp prefix ensures migrations run in the correct order.</p></section><section class="chapter"><h3 id="custom-migration-path" data-toc="custom-migration-path">Custom Migration Path</h3><p id="z8pjcxg_47">Specify a different location for your migrations:</p><div class="code-block" data-lang="bash">
elegant make:migration CreatePostsTable --path ./database/migrations
</div></section><section class="chapter"><h3 id="naming-conventions" data-toc="naming-conventions">Naming Conventions</h3><p id="z8pjcxg_49">Use descriptive names that clearly indicate what the migration does:</p><div class="code-block" data-lang="bash">
# Good migration names
elegant make:migration CreateUsersTable
elegant make:migration AddEmailVerificationToUsers
elegant make:migration CreateOrdersTable
elegant make:migration AddIndexToProductsSku

# Avoid vague names
elegant make:migration UpdateDatabase
elegant make:migration Changes
</div></section></section><section class="chapter"><h2 id="migration-structure" data-toc="migration-structure">Migration Structure</h2><section class="chapter"><h3 id="basic-structure" data-toc="basic-structure">Basic Structure</h3><p id="z8pjcxg_54">A migration class contains two essential methods:</p><ul class="list _bullet" id="z8pjcxg_55"><li class="list__item" id="z8pjcxg_57"><p id="z8pjcxg_59"><span class="control" id="z8pjcxg_60"><code class="code" id="z8pjcxg_61">up()</code> Method</span> - Defines forward changes (creating tables, adding columns, etc.)</p></li><li class="list__item" id="z8pjcxg_58"><p id="z8pjcxg_62"><span class="control" id="z8pjcxg_63"><code class="code" id="z8pjcxg_64">down()</code> Method</span> - Defines how to undo those changes (dropping tables, removing columns, etc.)</p></li></ul><div class="code-block" data-lang="ts">
import { Migration } from '@pristine/elegant';

export class CreateUsersTable extends Migration {
  /**
   * Run the migration - creates schema changes
   */
  async up() {
    await this.schema.create('users', (table) =&gt; {
      table.id();
      table.string('name');
      table.string('email').unique();
      table.string('password');
      table.boolean('active').default(true);
      table.timestamps();
    });
  }

  /**
   * Reverse the migration - undoes schema changes
   */
  async down() {
    await this.schema.drop('users');
  }
}
</div></section><section class="chapter"><h3 id="using-specific-database-connections" data-toc="using-specific-database-connections">Using Specific Database Connections</h3><p id="z8pjcxg_65">By default, migrations execute against your primary database connection. However, you can specify an alternative connection for migrations that need to run against a different database:</p><div class="code-block" data-lang="ts">
export class CreateUsersTable extends Migration {
  connection = 'analytics';

  async up() { /* Migration logic */ }

  async down() { /* Rollback logic */ }
}
</div><p id="z8pjcxg_67">Setting the <code class="code" id="z8pjcxg_68">connection</code> property directs Elegant to run this migration against the named connection defined in your <code class="code" id="z8pjcxg_69">elegant.config.js</code> file. This is particularly useful when managing multiple databases or when certain tables need to reside in separate database instances. Conditional Migration Execution Elegant allows you to control whether a migration should execute based on runtime conditions. Implement the <code class="code" id="z8pjcxg_70">shouldRun()</code> method to define custom logic that determines if the migration proceeds:</p></section><section class="chapter"><h3 id="conditional-migration-execution" data-toc="conditional-migration-execution">Conditional Migration Execution</h3><div class="code-block" data-lang="ts">
export class CreateUsersTable extends Migration {
  shouldRun() {
    return process.env.ENABLE_USERS_TABLE === 'true';
  }

  async up() { /* Migration logic */ }

  async down() { /* Rollback logic */ }
}
</div><p id="z8pjcxg_72">When <code class="code" id="z8pjcxg_73">shouldRun()</code> returns false, Elegant skips the migration entirely. This feature enables environment-specific migrations, feature flag integration, or conditional schema changes based on application configuration. The method evaluates each time you run migrations, providing dynamic control over which schema changes apply to your database.</p></section></section><section class="chapter"><h2 id="creating-tables" data-toc="creating-tables">Creating Tables</h2><section class="chapter"><h3 id="basic-table-creation" data-toc="basic-table-creation">Basic Table Creation</h3><p id="z8pjcxg_76">Create a new table using the method: <code class="code" id="z8pjcxg_78">create</code></p><div class="code-block" data-lang="ts">
await this.schema.create('users', (table) =&gt; {
  table.id();
  table.string('name');
  table.string('email');
  table.timestamps();
});
</div></section><section class="chapter"><h3 id="complete-example" data-toc="complete-example">Complete Example</h3><p id="z8pjcxg_79">Here's a comprehensive table definition:</p><div class="code-block" data-lang="ts">
export class CreateUsersTable extends Migration {
  async up() {
    await this.schema.create('users', (table) =&gt; {
      // Primary key
      table.id();
      
      // String columns
      table.string('name', 100);
      table.string('email').unique();
      table.text('bio').nullable();
      
      // Numeric columns
      table.integer('age').nullable();
      table.decimal('balance', 10, 2).default(0);
      
      // Boolean columns
      table.boolean('active').default(true);
      table.boolean('email_verified').default(false);
      
      // Date/Time columns
      table.timestamp('email_verified_at').nullable();
      table.timestamps(); // created_at and updated_at
    });
  }
  
  async down() {
    await this.schema.drop('users');
  }
}
</div></section></section><section class="chapter"><h2 id="column-types" data-toc="column-types">Column Types</h2><section class="chapter"><h3 id="string-columns" data-toc="string-columns">String Columns</h3><div class="code-block" data-lang="ts">
// VARCHAR with default length (255)
table.string('name');

// VARCHAR with custom length
table.string('code', 50);

// CHAR with specified length
table.char('country_code', 2);

// TEXT column for long content
table.text('description');

// LONGTEXT for very large content
table.longText('article_content');
</div></section><section class="chapter"><h3 id="numeric-columns" data-toc="numeric-columns">Numeric Columns</h3><div class="code-block" data-lang="ts">
// Integer types
table.tinyInteger('status');      // TINYINT
table.smallInteger('quantity');   // SMALLINT
table.integer('views');           // INT
table.bigInteger('large_number'); // BIGINT

// Unsigned integers
table.unsignedTinyInteger('age');
table.unsignedInteger('count');
table.unsignedBigInteger('id');

// Decimal and floating point
table.decimal('price', 8, 2);     // DECIMAL(8,2)
table.float('rating');            // FLOAT
table.double('precise_value');    // DOUBLE
</div></section><section class="chapter"><h3 id="boolean-columns" data-toc="boolean-columns">Boolean Columns</h3><div class="code-block" data-lang="ts">
// Boolean (stored as TINYINT(1) in MySQL/MariaDB)
table.boolean('active');
table.boolean('is_admin').default(false);
</div></section><section class="chapter"><h3 id="date-and-time-columns" data-toc="date-and-time-columns">Date and Time Columns</h3><div class="code-block" data-lang="ts">
// Date only
table.date('birth_date');

// Time only
table.time('opening_time');

// DateTime
table.dateTime('event_start');

// Timestamp
table.timestamp('created_at');

// Timestamp with current time default
table.timestamp('updated_at').default('CURRENT_TIMESTAMP');

// Convenience method for created_at and updated_at
table.timestamps();
</div></section><section class="chapter"><h3 id="json-columns" data-toc="json-columns">JSON Columns</h3><div class="code-block" data-lang="ts">
// JSON column (where supported)
table.json('metadata');
table.json('settings').nullable();
</div></section><section class="chapter"><h3 id="binary-columns" data-toc="binary-columns">Binary Columns</h3><div class="code-block" data-lang="ts">
table.enum('status', ['pending', 'active', 'suspended', 'deleted']);
table.enum('role', ['user', 'admin', 'moderator']).default('user');
</div></section></section><section class="chapter"><h2 id="column-modifiers" data-toc="column-modifiers">Column Modifiers</h2><section class="chapter"><h3 id="constraints-and-options" data-toc="constraints-and-options">Constraints and Options</h3><p id="z8pjcxg_95">Add constraints and options to columns:</p><div class="code-block" data-lang="ts">
await this.schema.create('products', (table) =&gt; {
  table.id();
  
  // Nullable columns
  table.string('description').nullable();
  
  // Default values
  table.integer('stock').default(0);
  table.boolean('featured').default(false);
  table.timestamp('published_at').default('CURRENT_TIMESTAMP');
  
  // Unique constraints
  table.string('sku').unique();
  table.string('slug').unique();
  
  // Unsigned (positive numbers only)
  table.integer('quantity').unsigned();
  
  // Auto-increment
  table.integer('sort_order').autoIncrement();
  
  // Comments (where supported)
  table.string('code').comment('Product identification code');
  
  table.timestamps();
});
</div></section><section class="chapter"><h3 id="primary-keys" data-toc="primary-keys">Primary Keys</h3><div class="code-block" data-lang="ts">
// Auto-incrementing integer primary key (recommended)
table.id();

// Custom primary key name
table.id('user_id');

// Composite primary key
table.integer('user_id');
table.integer('role_id');
table.primary(['user_id', 'role_id']);

// UUID primary key
table.uuid('id').primary();
</div></section></section><section class="chapter"><h2 id="foreign-key-constraints" data-toc="foreign-key-constraints">Foreign Key Constraints</h2><p id="z8pjcxg_98">Elegant automatically generates foreign key constraint names using the <code class="code" id="z8pjcxg_103">fk_</code> prefix followed by the column name.</p><section class="chapter"><h3 id="defining-foreign-keys" data-toc="defining-foreign-keys">Defining Foreign Keys</h3><p id="z8pjcxg_104">Establish relationships between tables using foreign key constraints:</p><div class="code-block" data-lang="ts">
await this.schema.create('posts', (table) =&gt; {
  table.integer('user_id').unsigned();
  
  // Create a foreign key constraint
  table.foreign('user_id')
    .on('users')
    .references('id')
    .onDelete('CASCADE')
    .onUpdate('CASCADE');
});
</div></section><section class="chapter"><h3 id="composite-foreign-keys" data-toc="composite-foreign-keys">Composite Foreign Keys</h3><p id="z8pjcxg_106">When working with composite primary keys, Elegant supports foreign key constraints that reference multiple columns. The constraint name automatically follows the fk_ prefix pattern, with each column name joined by underscores.</p><section class="chapter"><h4 id="defining-composite-foreign-keys" data-toc="defining-composite-foreign-keys">Defining Composite Foreign Keys</h4><p id="z8pjcxg_108">Create a foreign key constraint that references multiple columns in another table:</p><div class="code-block" data-lang="ts">
table.interger('user_id')
table.foreign(['user_id', 'author_id'])
  .on('users')
  .references('id')
  .onDelete('CASCADE')
  .onUpdate('CASCADE');

</div></section></section><section class="chapter"><h3 id="shorthand-syntax" data-toc="shorthand-syntax">Shorthand Syntax</h3><p id="z8pjcxg_110">Elegant provides convenient shorthand methods for common foreign key patterns for numeric column.</p><section class="chapter"><h4 id="inline-foreign-key" data-toc="inline-foreign-key">Inline Foreign Key</h4><p id="z8pjcxg_115">Add a foreign key constraint directly to a column definition:</p><div class="code-block" data-lang="ts">
table.integer('author_id').foreign()
</div></section><section class="chapter"><h4 id="separate-declaration" data-toc="separate-declaration">Separate Declaration</h4><p id="z8pjcxg_117">Alternatively, declare the foreign key constraint separately:</p><div class="code-block" data-lang="ts">
table.integer('author_id')
table.foreign('author_id')
</div><p id="z8pjcxg_119">Both shorthand approaches automatically infer the referenced table by converting the column name to its plural form (removing the _ <code class="code" id="z8pjcxg_120">id</code> suffix). For example, <code class="code" id="z8pjcxg_121">company_id</code> references the <code class="code" id="z8pjcxg_122">companies</code> table.</p></section><section class="chapter"><h4 id="generated-sql" data-toc="generated-sql">Generated SQL</h4><div class="code-block" data-lang="ts">
CREATE TABLE `users` (
  `company_id` INT,
  CONSTRAINT `fk_company_id`
    FOREIGN KEY (`company_id`)
    REFERENCES `companies`(`id`)
)
</div></section><section class="chapter"><h4 id="explicit-foreign-key-configuration" data-toc="explicit-foreign-key-configuration">Explicit Foreign Key Configuration</h4><p id="z8pjcxg_124">Specify the referenced table and column explicitly while maintaining inline syntax:</p><div class="code-block" data-lang="ts">
// Creates an unsigned integer column with foreign key constraint
table.integer('user_id')
  .foreign('users', 'id')
  .onDelete('CASCADE')
  .onUpdate('CASCADE')
</div><p id="z8pjcxg_126">This approach combines column creation with explicit foreign key configuration and referential actions in a single fluent chain.</p></section></section><section class="chapter"><h3 id="indexes" data-toc="indexes">Indexes</h3><p id="z8pjcxg_127">Improve query performance with indexes:</p><div class="code-block" data-lang="ts">
await this.schema.create('products', (table) =&gt; {
  table.id();
  table.string('name');
  table.string('sku');
  table.string('category');
  table.decimal('price', 10, 2);
  
  // Single column index
  table.index('sku');
  
  // Named index
  table.index('category', 'idx_products_category');
  
  // Composite index
  table.index(['category', 'price']);
  
  // Unique index
  table.unique('sku');
  table.unique(['category', 'sku']);
  
  table.timestamps();
});
</div></section></section><section class="chapter"><h2 id="modifying-tables" data-toc="modifying-tables">Modifying Tables</h2><section class="chapter"><h3 id="adding-columns" data-toc="adding-columns">Adding Columns</h3><p id="z8pjcxg_134">Add columns to existing tables:</p><div class="code-block" data-lang="ts">
export class AddPhoneToUsers extends Migration {
  async up() {
    await this.schema.table('users', (table) =&gt; {
      table.string('phone', 20).nullable();
      table.string('address').nullable();
      table.alter();
    });
  }
  
  async down() {
    await this.schema.table('users', (table) =&gt; {
      table.dropColumn('phone');
      table.dropColumn('address');
      table.alter();
    });
  }
}
</div></section><section class="chapter"><h3 id="modifying-columns" data-toc="modifying-columns">Modifying Columns</h3><p id="z8pjcxg_136">Change existing column definitions:</p><div class="code-block" data-lang="ts">
export class ModifyUsersNameColumn extends Migration {
  async up() {
    await this.schema.table('users', (table) =&gt; {
      // Change column type or attributes
      table.string('name', 200).change();
      table.text('bio').nullable().change();
      table.alter();
    });
  }
  
  async down() {
    await this.schema.table('users', (table) =&gt; {
      table.string('name', 100).change();
      table.text('bio').notNullable().change();
      table.alter()
    });
  }
}
</div></section><section class="chapter"><h3 id="renaming-columns" data-toc="renaming-columns">Renaming Columns</h3><p id="z8pjcxg_138">Rename columns within a table:</p><div class="code-block" data-lang="ts">
export class RenameUsersNameColumn extends Migration {
  async up() {
    await this.schema.table('users', (table) =&gt; {
      table.renameColumn('name', 'full_name');
      table.alter()
    });
  }
  
  async down() {
    await this.schema.table('users', (table) =&gt; {
      table.renameColumn('full_name', 'name');
      table.alter()
    });
  }
}
</div></section><section class="chapter"><h3 id="dropping-columns" data-toc="dropping-columns">Dropping Columns</h3><p id="z8pjcxg_140">Remove columns from tables:</p><div class="code-block" data-lang="ts">
export class RemovePhoneFromUsers extends Migration {
  async up() {
    await this.schema.table('users', (table) =&gt; {
      table.dropColumn('phone');
      // Drop multiple columns
      table.dropColumns(['address', 'city', 'state']);
      table.alter();
    });
  }
  
  async down() {
    await this.schema.table('users', (table) =&gt; {
      table.string('phone', 20).nullable();
      table.string('address').nullable();
      table.string('city', 100).nullable();
      table.string('state', 2).nullable();
      table.alter();
    });
  }
}
</div></section><section class="chapter"><h3 id="managing-indexes" data-toc="managing-indexes">Managing Indexes</h3><p id="z8pjcxg_142">Add or remove indexes:</p><div class="code-block" data-lang="ts">
export class AddIndexesToProducts extends Migration {
  async up() {
    await this.schema.table('products', (table) =&gt; {
      // Add indexes
      table.index('category');
      table.index(['category', 'status'], 'idx_category_status');
      table.unique('sku');
      table.alter()
    });
  }
  
  async down() {
    await this.schema.table('products', (table) =&gt; {
      // Drop indexes
      table.dropIndex('category');
      table.dropIndex('idx_category_status');
      table.dropUnique('sku');
      table.alter()
    });
  }
}
</div></section></section><section class="chapter"><h2 id="renaming-and-dropping-tables" data-toc="renaming-and-dropping-tables">Renaming and Dropping Tables</h2><section class="chapter"><h3 id="renaming-tables" data-toc="renaming-tables">Renaming Tables</h3><div class="code-block" data-lang="ts">
export class RenameUsersToAccounts extends Migration {
  async up() {
    await this.schema.rename('users', 'accounts');
  }
  
  async down() {
    await this.schema.rename('accounts', 'users');
  }
}
</div></section><section class="chapter"><h3 id="dropping-tables" data-toc="dropping-tables">Dropping Tables</h3><div class="code-block" data-lang="ts">
export class DropUsersTable extends Migration {
  async up() {
    await this.schema.drop('users');
  }
  
  async down() {
    // Recreate the table
    await this.schema.table('users', (table) =&gt; {
      table.id();
      table.string('name');
      table.string('email');
      table.timestamps();
      table.create()
    });
  }
}
</div></section><section class="chapter"><h3 id="drop-if-exists" data-toc="drop-if-exists">Drop If Exists</h3><p id="z8pjcxg_149">Safely drop tables that may not exist:</p><div class="code-block" data-lang="ts">
export class DropOldTables extends Migration {
  async up() {
    await this.schema.dropIfExists('old_users');
    await this.schema.dropIfExists('deprecated_logs');
  }
  
  async down() {
    // Usually no down action needed for cleanup migrations
  }
}
</div></section></section><section class="chapter"><h2 id="creating-functions" data-toc="creating-functions">Creating Functions</h2><p id="z8pjcxg_151">Create stored functions within your migrations using the <code class="code" id="z8pjcxg_159">table.fn()</code> method. Functions are reusable database routines that return a single value and can be called from queries.</p><section class="chapter"><h3 id="basic-function-definition" data-toc="basic-function-definition">Basic Function Definition</h3><div class="code-block" data-lang="ts">
await this.schema.fn('get_user_email', (fn) =&gt; { 
  fn('get_user_email', (fn) =&gt; { 
    fn.params.int('user_id_in');
     fn.returns.string('email_out');
    fn.body = `
      SELECT email INTO email_out FROM users WHERE id = user_id_in; 
      RETURN email_out; 
    `;
  });
})
</div><p id="z8pjcxg_161"><span class="control" id="z8pjcxg_163">Return Type</span> - Specify what the function returns using <code class="code" id="z8pjcxg_164">fn.returns</code>:</p><div class="code-block" data-lang="ts">
// Returns integer 
fn.returns.int('id'); 
// Returns VARCHAR(255) 
fn.returns.string('name'); 
// Returns DECIMAL(10,2) 
fn.returns.decimal('weight', 10, 2); 
// Returns boolean
fn.returns.boolean('is_active'); 
</div></section><section class="chapter"><h3 id="complete-examples" data-toc="complete-examples">Complete Examples</h3><p id="z8pjcxg_165"><span class="control" id="z8pjcxg_170">Calculate User Statistics:</span></p><div class="code-block" data-lang="ts">
await this.schema.fn('calculate_user_posts_count', (fn) =&gt; { 
  fn.params.int('user_id_in');
   fn.returns.int('post_count')
  fn.body = `
    SELECT COUNT(*) INTO post_count 
    FROM posts WHERE posts.user_id = user_id_in 
      AND posts.deleted_at IS NULL; 
   RETURN post_count; 
  `;
});
</div><ul class="list _bullet" id="z8pjcxg_167"><li class="list__item" id="z8pjcxg_171"><p id="z8pjcxg_173"><code class="code" id="z8pjcxg_174">fn.params</code>are automatically declared with the respective type and available within the function body</p></li><li class="list__item" id="z8pjcxg_172"><p id="z8pjcxg_175"><code class="code" id="z8pjcxg_176">fn.returns</code> - the return type is automatically defined and is available withint the function body</p></li></ul><p id="z8pjcxg_168"><span class="control" id="z8pjcxg_177">Format User Display Name:</span></p><div class="code-block" data-lang="ts">
await this.schema.fn('get_user_display_name', (fn) =&gt; { 
  fn.params.int('user_id');
  fn.body = `
    DECLARE display_name VARCHAR(255); 
    SELECT CONCAT(first_name, ' ', last_name) INTO display_name 
    FROM users WHERE id = user_id; RETURN display_name;
  `; 
  fn.returns.string(); 
});
</div></section><section class="chapter"><h3 id="multiple-parameters" data-toc="multiple-parameters">Multiple Parameters</h3><p id="z8pjcxg_178">Functions can accept multiple parameters:</p><div class="code-block" data-lang="ts">
await this.schema.fn('calculate_discount_price', (fn) =&gt; { 
  fn.params.decimal('original_price', 10, 2); 
  fn.params.decimal('discount_percent', 5, 2); 
  fn.body = `RETURN original_price * (1 - discount_percent / 100);`; 
  fn.returns.decimal(10, 2); 
});
</div></section><section class="chapter"><h3 id="using-functions-in-queries" data-toc="using-functions-in-queries">Using Functions in Queries</h3><p id="z8pjcxg_180">Once created, you can call these functions in your queries:</p><div class="code-block" data-lang="ts">
// Using the query builder
const email = await db.table('users') 
  .selectRaw('get_user_email(id) as email') 
     .where('id', userId) 
  .first();
// Using raw queries 
const postCount = await db.raw( 'SELECT calculate_user_posts_count(?) as count', [userId] );
</div></section><section class="chapter"><h3 id="database-support" data-toc="database-support">Database Support</h3><p id="z8pjcxg_182">Function creation is currently supported for:</p><ul class="list _bullet" id="z8pjcxg_183"><li class="list__item" id="z8pjcxg_184"><p id="z8pjcxg_188"><span class="control" id="z8pjcxg_189">MySQL</span> - Full support</p></li><li class="list__item" id="z8pjcxg_185"><p id="z8pjcxg_190"><span class="control" id="z8pjcxg_191">MariaDB</span> - Full support</p></li><li class="list__item" id="z8pjcxg_186"><p id="z8pjcxg_192"><span class="control" id="z8pjcxg_193">PostgreSQL</span> - Syntax may differ, test thoroughly</p></li><li class="list__item" id="z8pjcxg_187"><p id="z8pjcxg_194"><span class="control" id="z8pjcxg_195">SQLite</span> - Not supported (SQLite uses a different approach for functions)</p></li></ul></section><section class="chapter"><h3 id="best-practices" data-toc="best-practices">Best Practices</h3><ol class="list _decimal" id="z8pjcxg_196" type="1"><li class="list__item" id="z8pjcxg_197"><p id="z8pjcxg_202"><span class="control" id="z8pjcxg_203">Keep Functions Simple</span> - Complex logic is often better in application code</p></li><li class="list__item" id="z8pjcxg_198"><p id="z8pjcxg_204"><span class="control" id="z8pjcxg_205">Handle NULL Values</span> - Use <code class="code" id="z8pjcxg_206">COALESCE()</code> or NULL checks</p></li><li class="list__item" id="z8pjcxg_199"><p id="z8pjcxg_207"><span class="control" id="z8pjcxg_208">Name Descriptively</span> - Use clear names like <code class="code" id="z8pjcxg_209">calculate_*</code> or <code class="code" id="z8pjcxg_210">get_*</code></p></li><li class="list__item" id="z8pjcxg_200"><p id="z8pjcxg_211"><span class="control" id="z8pjcxg_212">Document Logic</span> - Add comments in complex function bodies</p></li><li class="list__item" id="z8pjcxg_201"><p id="z8pjcxg_213"><span class="control" id="z8pjcxg_214">Test Thoroughly</span> - Functions are harder to debug than application code</p></li></ol></section><section class="chapter"><h3 id="dropping-functions" data-toc="dropping-functions">Dropping Functions</h3><p id="z8pjcxg_215">To remove a function in a migration's <code class="code" id="z8pjcxg_218">down()</code> method:</p><div class="code-block" data-lang="ts">
async down() { 
   await this.schema.dropFn('users')
   // postgres requires you specify the parameters to drop function
   await this.schema.dropFn('users', fn =&gt; {
     fn.params.string('user_id')
   })
   // you can also run a raw query to drop the function
  await this.db.raw('DROP FUNCTION IF EXISTS get_user_email'); 
}
</div><aside class="prompt" data-type="note" data-title="" id="z8pjcxg_217"><p id="z8pjcxg_219"><span class="control" id="z8pjcxg_220">Note:</span> Functions are database-specific features. If you need to support multiple database types, consider implementing the logic in your application code instead.</p></aside></section></section><section class="chapter"><h2 id="running-migrations" data-toc="running-migrations">Running Migrations</h2><section class="chapter"><h3 id="execute-all-pending-migrations" data-toc="execute-all-pending-migrations">Execute All Pending Migrations</h3><p id="z8pjcxg_224">Run all migrations that haven't been executed yet:</p><div class="code-block" data-lang="bash">
elegant migrate
</div><p id="z8pjcxg_226">This command:</p><ol class="list _decimal" id="z8pjcxg_227" type="1"><li class="list__item" id="z8pjcxg_228"><p id="z8pjcxg_231">Checks which migrations have already run</p></li><li class="list__item" id="z8pjcxg_229"><p id="z8pjcxg_232">Executes pending migrations in chronological order</p></li><li class="list__item" id="z8pjcxg_230"><p id="z8pjcxg_233">Records successful migrations in the migrations tracking table</p></li></ol></section><section class="chapter"><h3 id="check-migration-status" data-toc="check-migration-status">Check Migration Status</h3><p id="z8pjcxg_234">View which migrations have run and which are pending:</p><div class="code-block" data-lang="bash">
elegant migrate:status
</div><p id="z8pjcxg_236">Output example:</p><div class="code-block" data-lang="bash">
Migration Status:
✓ 20250101120000_CreateUsersTable
✓ 20250101130000_CreatePostsTable
✗ 20250102140000_AddPhoneToUsers (pending)
</div></section><section class="chapter"><h3 id="migration-output" data-toc="migration-output">Migration Output</h3><p id="z8pjcxg_238">Migrations provide feedback as they run:</p><div class="code-block" data-lang="bash">
Running migrations...
✓ CreateUsersTable
✓ CreatePostsTable
✓ AddPhoneToUsers

Migrations completed successfully.
</div></section></section><section class="chapter"><h2 id="rolling-back-migrations" data-toc="rolling-back-migrations">Rolling Back Migrations</h2><section class="chapter"><h3 id="rollback-last-batch" data-toc="rollback-last-batch">Rollback Last Batch</h3><p id="z8pjcxg_248">Undo the most recent migration batch:</p><div class="code-block" data-lang="bash">
elegant migrate:rollback
</div><p id="z8pjcxg_250">This executes the <code class="code" id="z8pjcxg_251">down()</code> method of the last batch of migrations.</p></section><section class="chapter"><h3 id="rollback-multiple-batches" data-toc="rollback-multiple-batches">Rollback Multiple Batches</h3><p id="z8pjcxg_252">Rollback a specific number of migration batches:</p><div class="code-block" data-lang="bash">
# Rollback last 3 batches
elegant migrate:rollback --step=3
</div></section><section class="chapter"><h3 id="rollback-all-migrations" data-toc="rollback-all-migrations">Rollback All Migrations</h3><p id="z8pjcxg_254">Reset the database to its initial state:</p><div class="code-block" data-lang="bash">
elegant migrate:reset
</div><aside class="prompt" data-type="warning" data-title="" id="z8pjcxg_256"><p id="z8pjcxg_260">Warning: Data Loss Rolling back migrations will drop tables and delete data. Always backup your database before rolling back migrations in production environments.</p></aside><p id="z8pjcxg_257">Migration Best Practices</p><ol class="list _decimal" id="z8pjcxg_258" type="1"><li class="list__item" id="z8pjcxg_261"><p id="z8pjcxg_262">Always Provide Down Methods Every migration should have a working down() method:</p></li></ol><div class="code-block" data-lang="ts">
// Good
export class CreateUsersTable extends Migration {
  async up() {
    await this.schema.create('users', (table) =&gt; {
      // table definition
    });
  }
  
  async down() {
    await this.schema.drop('users');
  }
}

// Bad - missing down() implementation
export class CreateUsersTable extends Migration {
  async up() {
    await this.schema.create('users', (table) =&gt; {
      // table definition
    });
  }
  
  async down() {
    // TODO: Implement rollback
  }
}
</div></section><section class="chapter"><h3 id="2-keep-migrations-focused" data-toc="2-keep-migrations-focused">2. Keep Migrations Focused</h3><p id="z8pjcxg_263">Each migration should do one thing:</p><div class="code-block" data-lang="ts">
// Good - single purpose
export class AddEmailVerificationToUsers extends Migration {
  // Only adds email verification fields
}

// Bad - does too much
export class UpdateUsersAndPosts extends Migration {
  // Modifies multiple unrelated tables
}
</div></section><section class="chapter"><h3 id="3-test-migrations-both-ways" data-toc="3-test-migrations-both-ways">3. Test Migrations Both Ways</h3><p id="z8pjcxg_265">Always test both <code class="code" id="z8pjcxg_267">up()</code> and <code class="code" id="z8pjcxg_268">down()</code> methods:</p><div class="code-block" data-lang="bash">
# Run migration
elegant migrate

# Test rollback
elegant migrate:rollback

# Re-run migration
elegant migrate
</div></section><section class="chapter"><h3 id="4-use-descriptive-names" data-toc="4-use-descriptive-names">4. Use Descriptive Names</h3><p id="z8pjcxg_269">Migration names should clearly describe what they do:</p><div class="code-block" data-lang="none">
// Good
CreateUsersTable
AddEmailVerificationToUsers
AddIndexToProductsSku
CreateOrdersTable

// Bad
UpdateDatabase
Changes
Migration1
Fix
</div></section><section class="chapter"><h3 id="5-handle-production-carefully" data-toc="5-handle-production-carefully">5. Handle Production Carefully</h3><p id="z8pjcxg_271">In production environments:</p><ul class="list _bullet" id="z8pjcxg_272"><li class="list__item" id="z8pjcxg_273"><p id="z8pjcxg_278"><span class="control" id="z8pjcxg_279">Backup first</span> - Always backup before running migrations</p></li><li class="list__item" id="z8pjcxg_274"><p id="z8pjcxg_280"><span class="control" id="z8pjcxg_281">Review changes</span> - Understand what each migration does</p></li><li class="list__item" id="z8pjcxg_275"><p id="z8pjcxg_282"><span class="control" id="z8pjcxg_283">Plan downtime</span> - Some migrations may require brief downtime</p></li><li class="list__item" id="z8pjcxg_276"><p id="z8pjcxg_284"><span class="control" id="z8pjcxg_285">Test in staging</span> - Run migrations in a staging environment first</p></li><li class="list__item" id="z8pjcxg_277"><p id="z8pjcxg_286"><span class="control" id="z8pjcxg_287">Monitor performance</span> - Large table alterations can be slow</p></li></ul></section><section class="chapter"><h3 id="6-version-control" data-toc="6-version-control">6. Version Control</h3><ul class="list _bullet" id="z8pjcxg_288"><li class="list__item" id="z8pjcxg_289"><p id="z8pjcxg_292">Always commit migration files to version control</p></li><li class="list__item" id="z8pjcxg_290"><p id="z8pjcxg_293">Never modify migrations that have run in production</p></li><li class="list__item" id="z8pjcxg_291"><p id="z8pjcxg_294">Create new migrations to fix issues instead of editing old ones</p></li></ul></section></section><section class="chapter"><h2 id="database-specific-considerations" data-toc="database-specific-considerations">Database-Specific Considerations</h2><section class="chapter"><h3 id="mysql-mariadb" data-toc="mysql-mariadb">MySQL / MariaDB</h3><div class="code-block" data-lang="ts">
await this.schema.create('users', (table) =&gt; {
  table.id();
  table.string('name');
  
  // MySQL specific options
  table.engine('InnoDB');
  table.charset('utf8mb4');
  table.collation('utf8mb4_unicode_ci');
});
</div></section><section class="chapter"><h3 id="postgresql" data-toc="postgresql">PostgreSQL</h3><div class="code-block" data-lang="ts">
// PostgreSQL supports more advanced column types
table.json('metadata');          // JSON column
table.jsonb('settings');         // JSONB column (more efficient)
table.uuid('id').primary();      // UUID primary key
</div></section><section class="chapter"><h3 id="sqlite" data-toc="sqlite">SQLite</h3><p id="z8pjcxg_300">SQLite has some limitations:</p><ul class="list _bullet" id="z8pjcxg_301"><li class="list__item" id="z8pjcxg_303"><p id="z8pjcxg_306">Limited <code class="code" id="z8pjcxg_307">ALTER TABLE</code> support</p></li><li class="list__item" id="z8pjcxg_304"><p id="z8pjcxg_308">No <code class="code" id="z8pjcxg_309">ENUM</code> type (use CHECK constraints)</p></li><li class="list__item" id="z8pjcxg_305"><p id="z8pjcxg_310">Foreign keys must be enabled explicitly</p></li></ul><div class="code-block" data-lang="ts">
// SQLite limitations
// ✓ Supported
table.string('name');
table.integer('age');

// ✗ Limited support
table.renameColumn('old', 'new');  // Not supported
table.dropColumn('column');         // Not supported
</div></section></section><section class="chapter"><h2 id="troubleshooting" data-toc="troubleshooting">Troubleshooting</h2><section class="chapter"><h3 id="migration-failed" data-toc="migration-failed">Migration Failed</h3><p id="z8pjcxg_313">If a migration fails midway:</p><ol class="list _decimal" id="z8pjcxg_314" type="1"><li class="list__item" id="z8pjcxg_315"><p id="z8pjcxg_320">Check the error message for details</p></li><li class="list__item" id="z8pjcxg_316"><p id="z8pjcxg_321">Review the migration code</p></li><li class="list__item" id="z8pjcxg_317"><p id="z8pjcxg_322">Fix the issue</p></li><li class="list__item" id="z8pjcxg_318"><p id="z8pjcxg_323">Rollback if necessary: <code class="code" id="z8pjcxg_324">elegant migrate:rollback</code></p></li><li class="list__item" id="z8pjcxg_319"><p id="z8pjcxg_325">Re-run the migration: <code class="code" id="z8pjcxg_326">elegant migrate</code></p></li></ol></section><section class="chapter"><h3 id="multiple-connections" data-toc="multiple-connections">Multiple Connections</h3><p id="z8pjcxg_327">Specify which connection to use:</p><div class="code-block" data-lang="ts">
export class CreateAnalyticsEvents extends Migration {
  connection = 'analytics';
  
  async up() {
    await this.schema.create('events', (table) =&gt; {
      table.id();
      table.string('event_name');
      table.timestamps();
    });
  }
  
  async down() {
    await this.schema.drop('events');
  }
}
</div><p id="z8pjcxg_329">Run migrations for a specific connection:</p><div class="code-block" data-lang="bash">
elegant migrate --connection=analytics
</div></section></section><section class="chapter"><h2 id="next-steps" data-toc="next-steps">Next Steps</h2><ul class="list _bullet" id="z8pjcxg_331"><li class="list__item" id="z8pjcxg_332"><p id="z8pjcxg_335">Learn about <a href="query-builder.html" id="z8pjcxg_336" data-tooltip="Elegant's query builder provides an intuitive, fluent interface for constructing and executing database queries. Rather than writing raw SQL strings throughout your application, the query builder offers a chainable API that's both readable and maintainable.">Query Builder</a> to interact with your database</p></li><li class="list__item" id="z8pjcxg_333"><p id="z8pjcxg_337">Explore <a href="elegant-getting-started.html" id="z8pjcxg_338" data-tooltip="The Elegant ORM (Object-Relational Mapper) transforms database tables into intuitive TypeScript classes, letting you work with database records as objects rather than writing raw SQL. This object-oriented approach makes your code more maintainable, readable, and enjoyable to write.">Elegant ORM</a> for model-based interactions</p></li><li class="list__item" id="z8pjcxg_334"><p id="z8pjcxg_339">Review <a href="getting-started.html" id="z8pjcxg_340" data-tooltip="Modern applications depend on reliable, efficient database interactions. Elegant simplifies this process by providing a clean, expressive interface for working with databases. Whether you need raw SQL power, a fluent query builder, or an elegant ORM, this toolkit has you covered.">database configuration</a> options</p></li></ul></section><div class="last-modified">26 October 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="query-builder.html" class="navigation-links__prev">Database: Query Builder</a><a href="elegant-getting-started.html" class="navigation-links__next">Elegant ORM: Getting Started</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>